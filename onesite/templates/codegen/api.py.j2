from typing import List, Any, Optional
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlmodel import Session, select, func, col
from app.core import db
from app.schemas.{{ model.lower_name }} import {{ model.name }}Read, {{ model.name }}Create, {{ model.name }}Update
from app.schemas.pagination import PaginatedResponse
from app.services.{{ model.lower_name }} import service
from app.models.{{ model.lower_name }} import {{ model.name }}

router = APIRouter()

@router.get("/", response_model=PaginatedResponse[{{ model.name }}Read])
def read_{{ model.lower_name }}s(
    page: int = 1,
    size: int = 20,
    q: Optional[str] = Query(None, description="Search query"),
    session: Session = Depends(db.get_session),
) -> Any:
    # Calculate skip based on page and size
    skip = (page - 1) * size
    
    # Base statement
    statement = select({{ model.name }})
    
    # Apply search filter if query is present
    {% if model.search_field != 'id' %}
    if q:
        statement = statement.where(col({{ model.name }}.{{ model.search_field }}).ilike(f"%{q}%"))
    {% endif %}
    
    # Get total count (before limit/offset)
    total_statement = select(func.count()).select_from(statement.subquery())
    total = session.exec(total_statement).one()
    
    # Apply pagination
    statement = statement.offset(skip).limit(size)
    items = session.exec(statement).all()
    
    return PaginatedResponse.create(data=items, total=total, page=page, size=size)

@router.post("/", response_model={{ model.name }}Read)
def create_{{ model.lower_name }}(
    *,
    session: Session = Depends(db.get_session),
    {{ model.lower_name }}_in: {{ model.name }}Create,
) -> Any:
    return service.create(session, {{ model.lower_name }}_in)

@router.get("/{id}", response_model={{ model.name }}Read)
def read_{{ model.lower_name }}(
    *,
    session: Session = Depends(db.get_session),
    id: int,
) -> Any:
    {{ model.lower_name }} = service.get(session, id)
    if not {{ model.lower_name }}:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")
    return {{ model.lower_name }}

@router.put("/{id}", response_model={{ model.name }}Read)
def update_{{ model.lower_name }}(
    *,
    session: Session = Depends(db.get_session),
    id: int,
    {{ model.lower_name }}_in: {{ model.name }}Update,
) -> Any:
    {{ model.lower_name }} = service.get(session, id)
    if not {{ model.lower_name }}:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")
    {{ model.lower_name }} = service.update(session, {{ model.lower_name }}, {{ model.lower_name }}_in)
    return {{ model.lower_name }}

@router.delete("/{id}", response_model={{ model.name }}Read)
def delete_{{ model.lower_name }}(
    *,
    session: Session = Depends(db.get_session),
    id: int,
) -> Any:
    {{ model.lower_name }} = service.get(session, id)
    if not {{ model.lower_name }}:
        raise HTTPException(status_code=404, detail="{{ model.name }} not found")
    {{ model.lower_name }} = service.delete(session, id)
    return {{ model.lower_name }}
