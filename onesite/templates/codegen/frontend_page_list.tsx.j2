import React, { useState, useEffect } from 'react';
import { Plus, Pencil, Trash2, Loader2, Eye } from 'lucide-react';
import { useForm, Controller } from 'react-hook-form';
import { useNavigate } from 'react-router-dom';
import { {{ model.name }} } from '../../services/{{ model.lower_name }}';
import { use{{ model.name }}Store } from '../../stores/use{{ model.name }}Store';
import { Button } from '../../components/ui/button';
import { Input } from '../../components/ui/input';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '../../components/ui/table';
import { Modal } from '../../components/ui/modal';
import { Label } from '../../components/ui/label';
import { Badge } from '../../components/ui/badge';
import { Switch } from '../../components/ui/switch';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../components/ui/select';
import { SearchableSelect } from '../../components/ui/searchable-select';
{% for fk in model.foreign_keys %}
import { get{{ fk.target_endpoint.capitalize() }} } from '../../services/{{ fk.target_service }}';
{% endfor %}

const {{ model.name }}Page: React.FC = () => {
  const navigate = useNavigate();
  const { data, loading, fetchData, createItem, updateItem, deleteItem } = use{{ model.name }}Store();
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingId, setEditingId] = useState<number | null>(null);
  
  const { register, handleSubmit, reset, setValue, control } = useForm();

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  const handleCreate = () => {
    setEditingId(null);
    reset();
    setIsModalOpen(true);
  };

  const handleEdit = (record: {{ model.name }}) => {
    setEditingId(record.id);
    // Set form values
    {% for field in model.fields %}
    {% if ('c' in field.permissions or 'u' in field.permissions) and 'r' in field.permissions %}
    setValue('{{ field.name }}', record.{{ field.name }});
    {% endif %}
    {% endfor %}
    setIsModalOpen(true);
  };

  const handleDelete = async (id: number) => {
    if (!confirm('Are you sure?')) return;
    try {
      await deleteItem(id);
    } catch (error) {
      console.error(error);
    }
  };

  const onSubmit = async (values: any) => {
    try {
      if (editingId) {
        await updateItem(editingId, values);
      } else {
        await createItem(values);
      }
      setIsModalOpen(false);
    } catch (error) {
      console.error(error);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold tracking-tight">{{ model.name }}s</h1>
        <Button onClick={handleCreate}>
          <Plus className="mr-2 h-4 w-4" /> New {{ model.name }}
        </Button>
      </div>

      <div className="border rounded-md">
        <Table>
          <TableHeader>
            <TableRow>
              {% for field in model.fields %}
              {% if 'r' in field.permissions %}
              <TableHead>{{ field.name }}</TableHead>
              {% endif %}
              {% endfor %}
              <TableHead className="w-[100px]">Actions</TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {loading ? (
                <TableRow>
                    <TableCell colSpan={ {{ model.fields|length + 1 }} } className="h-24 text-center">
                        <Loader2 className="h-6 w-6 animate-spin mx-auto" />
                    </TableCell>
                </TableRow>
            ) : data.length === 0 ? (
                <TableRow>
                    <TableCell colSpan={ {{ model.fields|length + 1 }} } className="h-24 text-center">
                        No results.
                    </TableCell>
                </TableRow>
            ) : (
                data.map((item) => (
                <TableRow key={item.id}>
                    {% for field in model.fields %}
                    {% if 'r' in field.permissions %}
                    <TableCell>
                        {% if field.ui_type == 'bool' %}
                        <Badge variant={item.{{ field.name }} ? "default" : "secondary"}>
                            {item.{{ field.name }} ? 'Yes' : 'No'}
                        </Badge>
                        {% elif field.is_enum %}
                        <Badge variant="outline">{item.{{ field.name }}}</Badge>
                        {% else %}
                        {String(item.{{ field.name }})}
                        {% endif %}
                    </TableCell>
                    {% endif %}
                    {% endfor %}
                    <TableCell className="flex items-center gap-2">
                        <Button variant="ghost" size="icon" onClick={() => navigate(`/{{ model.lower_name }}s/${item.id}`)}>
                            <Eye className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="icon" onClick={() => handleEdit(item)}>
                            <Pencil className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="icon" className="text-destructive" onClick={() => handleDelete(item.id)}>
                            <Trash2 className="h-4 w-4" />
                        </Button>
                    </TableCell>
                </TableRow>
                ))
            )}
          </TableBody>
        </Table>
      </div>
      
      {/* Pagination Controls */}
      <div className="flex items-center justify-end space-x-2">
        <div className="flex-1 text-sm text-muted-foreground">
            Page {use{{ model.name }}Store(state => state.page)} of {Math.ceil(use{{ model.name }}Store(state => state.total) / use{{ model.name }}Store(state => state.size)) || 1}
        </div>
        <div className="space-x-2">
            <Button
                variant="outline"
                size="sm"
                onClick={() => fetchData(use{{ model.name }}Store.getState().page - 1, use{{ model.name }}Store.getState().size)}
                disabled={use{{ model.name }}Store(state => state.page) <= 1 || loading}
            >
                Previous
            </Button>
            <Button
                variant="outline"
                size="sm"
                onClick={() => fetchData(use{{ model.name }}Store.getState().page + 1, use{{ model.name }}Store.getState().size)}
                disabled={use{{ model.name }}Store(state => state.page) >= Math.ceil(use{{ model.name }}Store(state => state.total) / use{{ model.name }}Store(state => state.size)) || loading}
            >
                Next
            </Button>
        </div>
      </div>

      <Modal 
        title={editingId ? "Edit {{ model.name }}" : "Create {{ model.name }}"} 
        isOpen={isModalOpen} 
        onClose={() => setIsModalOpen(false)}
      >
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
          {% for field in model.fields %}
          {% if 'c' in field.permissions or 'u' in field.permissions %}
          <div className="space-y-2">
            <Label htmlFor="{{ field.name }}">{{ field.name }}</Label>
            {% if field.ui_type == 'bool' %}
            <div className="flex items-center space-x-2">
                <Controller
                    control={control}
                    name="{{ field.name }}"
                    defaultValue={ {{ 'true' if field.default else 'false' }} }
                    render={({ field: { onChange, value } }) => (
                        <Switch checked={value} onCheckedChange={onChange} id="{{ field.name }}" />
                    )}
                />
                <Label htmlFor="{{ field.name }}" className="font-normal text-muted-foreground">
                    {{ field.name }}
                </Label>
            </div>
            {% elif field.is_enum %}
            <Controller
                control={control}
                name="{{ field.name }}"
                render={({ field: { onChange, value } }) => (
                    <Select onValueChange={onChange} defaultValue={value}>
                        <SelectTrigger>
                            <SelectValue placeholder="Select {{ field.name }}" />
                        </SelectTrigger>
                        <SelectContent>
                            {% for enum_val in field.enum_values %}
                            <SelectItem value="{{ enum_val }}">{{ enum_val }}</SelectItem>
                            {% endfor %}
                        </SelectContent>
                    </Select>
                )}
            />
            {% elif field.fk_info %}
            <Controller
                control={control}
                name="{{ field.name }}"
                render={({ field: { onChange, value } }) => (
                    <SearchableSelect
                        value={value}
                        onValueChange={onChange}
                        placeholder="Select {{ field.name }}"
                        searchPlaceholder="Search {{ field.fk_info.target_model }}..."
                        loadOptions={async (query) => {
                            const response = await get{{ field.fk_info.target_endpoint.capitalize() }}(1, 20, query);
                            return response.items.map((item: any) => ({
                                label: item.{{ field.fk_info.label_field }} || item.id,
                                value: item.id
                            }));
                        }}
                    />
                )}
            />
            {% else %}
            <Input 
                id="{{ field.name }}"
                {% if field.ui_type == 'int' or field.ui_type == 'float' %}
                type="number"
                {% else %}
                type="text"
                {% endif %}
                {...register('{{ field.name }}', { required: {{ 'true' if field.required else 'false' }} })}
            />
            {% endif %}
          </div>
          {% endif %}
          {% endfor %}
          <div className="flex justify-end space-x-2 pt-4">
            <Button variant="outline" type="button" onClick={() => setIsModalOpen(false)}>Cancel</Button>
            <Button type="submit">Save</Button>
          </div>
        </form>
      </Modal>
    </div>
  );
};

export default {{ model.name }}Page;
